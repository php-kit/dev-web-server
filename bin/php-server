#!/bin/bash

# check if stdout is a terminal
if test -t 1; then

  # see if it supports colors
  ncolors=$(tput colors)

  if test -n "$ncolors" && test $ncolors -ge 2; then
    HILIGHT='\033[0;32m'
    COMMENT='\033[0;33m'
    INFO='\033[0;36m'
    ERROR='\033[1;31m'
    B='\033[1;38m'
    U='\033[4;37m'
    C='\033[0m' # Clear (no color)
  fi
fi

getCWD ()
{
  local SOURCE="${BASH_SOURCE[0]}"
  # Resolve $SOURCE until the file is no longer a symlink.
  while [ -h "$SOURCE" ]; do
    local DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
    SOURCE="$(readlink "$SOURCE")"
    # If $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located.
    [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
  done
  echo "$( cd -P "$( dirname "$SOURCE" )" && pwd )"
}

self="$(basename $0)"
PID_FILE="/tmp/$self.pid"
BASE_DIR="$(dirname "$(getCWD)")"
ROUTER_FILE="$BASE_DIR/src/devServerRouter.php"
plist="$HOME/Library/LaunchAgents/php-server.plist"
php="php"
log="$HOME/.php-server.log"

syntax()
{
  printf "
${B}SYNTAX$C
    ${B}$self$C ${U}command$C [${U}options$C]
    ${B}$self$C [${B}--help$C]

${B}COMMAND$C
    ${HILIGHT}${B}start$C - Starts the web server.

        ${B}SYNTAX$C
            ${B}$self start$C [${B}-p$C|${B}--port$C] [${B}-a$C|${B}--address$C] [${B}-l$C|${B}--log$C] [${B}-g$C|${B}--global$C] [${B}-r$C|${B}--root$C] [${B}-f$C|${B}--foreground$C] [${B}-x$C|${B}--executable$C]

        ${B}OPTIONS$C
            ${B}-p, --port       ${C}The TCP/IP port the web server will listen on.
                             $INFO[default: 8000]$C
            ${B}-a, --address    ${C}The IP address the web server will listen on.
                             $INFO[default: localhost]$C
            ${B}-l, --log        ${C}The path of a log file where the server's logging output will be saved.
                             Use $INFO/dev/null$C to disable.
                             $INFO[default: $log]$C
            ${B}-g, --global     ${C}If specified, the server will serve all sites under the root web directory.
            ${B}-r, --root       ${C}The root web directory's name or path. If it's a name, the directory will be searched for
                             starting at the current directory and going upwards. Alternatively, you may specify the
                             full path.
                             $INFO[default: Sites]$C
            ${B}-f, --foreground ${C}Don't run the server as a background process.
            ${B}-x, --executable ${C}The path to the PHP interpreter.
                             $INFO[default: searched on \$PATH]$C

${B}COMMAND$C
    ${HILIGHT}${B}stop$C - Stops the web server.

${B}COMMAND$C
    ${HILIGHT}${B}status$C - Checks if the web server is running.

${B}COMMAND$C
    ${HILIGHT}${B}install$C - Installs the server as a system user agent that is auto-started on login.
              The server runs in $INFO--global$C mode.
              ${B}This works on Mac OS X only!$C

        ${B}SYNTAX$C
            ${B}$self install$C [${B}-p$C|${B}--port$C] [${B}-a$C|${B}--address$C] [${B}-l$C|${B}--log$C] [${B}-r$C|${B}--root$C]

${B}COMMAND$C
    ${HILIGHT}${B}uninstall$C - Shuts down and uninstalls a previously installed user agent.
                ${B}This works on Mac OS X only!$C

"
  exit 1
}

error ()
{
  echo -e "
$1
"
  exit 1
}

finish ()
{
  echo -e "
$1
"
  exit 0
}

syntax-error ()
{
  echo -e "
${ERROR}Syntax error!$C"
  syntax
}

getPID ()
{
  # Case: server running as a standard process
  if [ -f "$PID_FILE" ]; then
    cat $PID_FILE 2>/dev/null
    return
  fi
  # Case: server running as an user agent
  if [ -f "$plist" ]; then
    # Case: server running as the current user
    pid=$(launchctl list | grep php-server | cut -f 1)
    if [ "$pid" != "-" -a "$pid" ]; then
      echo $pid
    fi
    # Case: server running as root (when port < 1024)
    launchctl print system/php-server 2>/dev/null | grep -o 'id\s*=.*' | grep -oE '\d+'
  fi
}

isRunning ()
{
  if [ -n "$1" ]; then
    ps "$1" > /dev/null 2>&1
  else
    $(exit 1)
  fi
}

runBackgroundCommand ()
{
  nohup $1 >$2 2>&1 & echo $!
}

getFileOwner ()
{
  stat -f '%Su' $1
}

requireSudo ()
{
  sudo -p "
Root privileges are required for this operation.
Your password:" ls > /dev/null || exit
}

command=$1
shift
case "$command" in

  "start")
    port=8000
    address="localhost"
    global=""
    rootWasSet=""
    root="Sites"
    foreground=""
    starting_daemon=""

    while true; do
      case "$1" in
        '')
          break;
          ;;
        --port|-p)
          shift
          port=$1
          ;;
        --address|-a)
          shift
          address=$1
          ;;
        --log|-l)
          shift
          log=$1
          ;;
        --global|-g)
          global=true
          ;;
        --root|-r)
          shift
          root=$1
          rootWasSet=true
          ;;
        --foreground|-f)
          foreground=true
          ;;
        --executable|-x)
          shift
          php=$1
          if [ ! -f "$php" ]; then
            error "$php ${ERROR}was not found$C"
          fi
          ;;
        -d)
          starting_daemon=true
          ;;
        *)
          error "Invalid argument ${ERROR}$1$C"
      esac
      shift
    done

    if [ -z "$starting_daemon" ]; then # only check if process exists when not starting the daemon
      pid=$(getPID)
      if isRunning "$pid"; then
        error "The server is ${ERROR}already running$C
PID: ${HILIGHT}$pid$C"
      fi
    fi
    dir=$(pwd)
    if [ -n "$global" ]; then
      if [ -d "$root" ]; then
        dir="$root"
      else
        while true; do
          current=$(basename "$dir")
          [ "$current" == "$root" ] && break
          dir=$(dirname "$dir")
          if [ "$dir" == "/" ]; then
            error "Directory ${ERROR}$root$C was not found"
          fi
        done
      fi
    else
      if [ $rootWasSet ]; then
        error "The ${B}--root$C option can only be used on ${HILIGHT}global$C mode"
      fi
    fi
    [ "$log" == "/dev/null" ] && logMsg="${COMMENT}disabled$C" || logMsg="${HILIGHT}$log$C"
    where="$address:$port"
    options='-d variables_order=EGPCS'

    # For ports < 1024 sudo is needed, but only if the script isn't being run as root (ex: via lauchd) to prevent process duplication
    if [ $port -lt 1024 -a $(id -u) -ne 0 ]; then
      requireSudo
      php="sudo $php"
    fi

    if [ -n "$foreground" ]; then
      exec $php -S $where -t $dir $options $ROUTER_FILE
    else
      pid=$(runBackgroundCommand "$php -S $where -t $dir $options $ROUTER_FILE" $log)
      echo $pid > $PID_FILE
      $0 status || exit $?
      # finish() is not used to prevent extra blank line
      echo -e "Listening at: ${HILIGHT}$where$C
Publishing:   ${HILIGHT}$dir$C
Log file:     ${HILIGHT}$logMsg$C
"
    fi
    ;;

  "stop")
    if [ -f "$plist" ]; then
      error "The server ${ERROR}can't be stopped$C because it's running as a user agent; use the ${HILIGHT}uninstall$C command instead"
    fi
    pid=$(getPID)
    if [ -z "$pid" ]; then
      error "The server is ${ERROR}already stopped$C"
    fi
    kill $pid 2>/dev/null
    if [ $? -eq 1 ]; then
      requireSudo
      sudo kill $pid 2>&1 || exit 1
    fi
    rm -f "$PID_FILE"
    rm -f "$log"
    finish "The web server is now ${HILIGHT}stopped$C"
    ;;

  "status")
    pid=$(getPID)
    if [ -z "$pid" ]; then
      error "The server is ${ERROR}not running$C"
    else
      if isRunning $pid; then
        finish "The server is ${HILIGHT}running$C
PID: ${HILIGHT}$pid$C"
      else
        rm -f $PID_FILE
        error "The server ${ERROR}crashed$C"
      fi
    fi
    ;;

  "install")
    if [ -f "$plist" ]; then
      error "The user agent is ${ERROR}already installed$C"
    fi
    pid=$(getPID)
    if [ -n "$pid" ]; then
      echo "
Shutting down the current server"
      $0 stop || exit $?
    fi

    port=8000
    address="localhost"
    root="$HOME/Sites"
    php=`which php` # capture the current PHP location, as it may be different when running as a user agent

    while true; do
      case "$1" in
        '')
          break;
          ;;
        --port|-p)
          shift
          port=$1
          ;;
        --address|-a)
          shift
          address=$1
          ;;
        --log|-l)
          shift
          log=$1
          ;;
        --root|-r)
          shift
          root=$1
          ;;
        *)
          error "Invalid argument ${ERROR}$1$C"
      esac
      shift
    done

    sudo=''
    if [ $port -lt 1024 ]; then
      requireSudo
      sudo='sudo'
    fi

    echo "<?xml version=\"1.0\" encoding=\"UTF-8\"?>
<!DOCTYPE plist PUBLIC \"-//Apple Computer//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\">
<plist version=\"1.0\">
<dict>
   <key>Label</key>
   <string>php-server</string>
   <key>ProgramArguments</key>
   <array>
      <string>$HOME/.composer/vendor/bin/php-server</string>
      <string>start</string>
      <string>-p</string>
      <string>$port</string>
      <string>-a</string>
      <string>$address</string>
      <string>-r</string>
      <string>$root</string>
      <string>-x</string>
      <string>$php</string>
      <string>-g</string>
      <string>-f</string>
      <string>-d</string>
   </array>
   <key>RunAtLoad</key>
   <true/>
   <key>StandardOutPath</key>
   <string>$log</string>
   <key>StandardErrorPath</key>
   <string>$log</string>
</dict>
</plist>
" > "$plist" || exit $?
    chmod 600 "$plist" || exit $?
    if [ -n "$sudo" ]; then
      sudo chown root "$plist"
    fi
    $sudo launchctl load "$plist" || exit $?
    echo -e "
The user agent is now ${HILIGHT}installed$C and it will auto-start whenever you log in"
    $0 status || exit $?
    [ "$log" == "/dev/null" ] && log="disabled"
    # finish() is not used to prevent extra blank line
    echo -e "Listening at: ${HILIGHT}$address:$port$C
Publishing:   ${HILIGHT}$root$C
Log file:     ${HILIGHT}$log$C
"
    ;;

  "uninstall")
    if [ -f "$plist" ]; then
      # Check if the agent runs as root
      sudo=''
      owner=$(getFileOwner "$plist")
      if [ "$owner" == 'root' ]; then
        requireSudo
        sudo='sudo'
      fi
      $sudo launchctl unload "$plist" || exit $?
      $sudo rm "$plist" || exit $?
      rm -f "$log"
      finish "The user agent is now ${HILIGHT}uninstalled$C"
    else
      error "The user agent is ${ERROR}already uninstalled$C"
    fi
    ;;

  "--help"|"")
  printf "
${B}NAME$C
    ${B}$self$C -- makes the PHP's built-in web server easier and more practical to use
"
    syntax
    ;;

  *)
    syntax-error
esac
